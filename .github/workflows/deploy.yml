name: Deploy GTD System to Firebase

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install root dependencies
      run: npm ci
      if: hashFiles('package-lock.json') != ''

    - name: Install PWA dependencies
      run: |
        cd gtd-pwa
        npm ci

    - name: Run PWA tests
      run: |
        cd gtd-pwa
        npm test -- --watchAll=false --passWithNoTests
      env:
        CI: true

    - name: Install Functions dependencies
      run: |
        cd functions
        npm ci

    - name: Lint Functions
      run: |
        cd functions
        npm run lint || echo "Linting completed with warnings"
      continue-on-error: true

  build:
    name: Build PWA
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install PWA dependencies
      run: |
        cd gtd-pwa
        npm ci

    - name: Build PWA
      run: |
        cd gtd-pwa
        npm run build
      env:
        CI: true
        REACT_APP_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
        REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
        REACT_APP_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
        REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
        REACT_APP_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}

    - name: Copy build to hosting directory
      run: |
        mkdir -p build
        cp -r gtd-pwa/build/* build/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build
        path: build/
        retention-days: 1

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    environment:
      name: staging
      url: https://personal-gtd-ea76d.web.app
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: build
        path: build/

    - name: Deploy to Firebase (Preview)
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        projectId: personal-gtd-ea76d
        expires: 7d

    - name: Comment PR with preview URL
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'üöÄ Preview deployment ready! Check the Firebase preview URL above.'
          })

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://personal-gtd-ea76d.web.app
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: build
        path: build/

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Firebase CLI
      run: npm install -g firebase-tools

    - name: Deploy to Firebase Hosting
      run: firebase deploy --only hosting --project personal-gtd-ea76d
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

    - name: Deploy Cloud Functions
      run: firebase deploy --only functions --project personal-gtd-ea76d
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

    - name: Deploy Firestore Rules
      run: firebase deploy --only firestore:rules --project personal-gtd-ea76d
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

    - name: Deploy Storage Rules
      run: firebase deploy --only storage --project personal-gtd-ea76d
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

    - name: Create deployment summary
      run: |
        echo "# Deployment Summary üöÄ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Hosting deployed**: https://personal-gtd-ea76d.web.app" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Cloud Functions deployed**" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Firestore rules updated**" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Storage rules updated**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Deployed from commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

    - name: Notify on success
      if: success()
      run: echo "üéâ Production deployment successful!"

    - name: Notify on failure
      if: failure()
      run: echo "‚ùå Production deployment failed. Check logs for details."

  backup:
    name: Trigger Backup
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Firebase CLI
      run: npm install -g firebase-tools

    - name: Trigger manual backup
      run: |
        firebase functions:call triggerBackup --project personal-gtd-ea76d
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      continue-on-error: true

    - name: Backup completion
      run: echo "‚úÖ Post-deployment backup triggered"
